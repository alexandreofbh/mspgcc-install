#/usr/bin/env bash
# Installs msp430-gcc (RedHat's version!), gdb and mspdebug
# JLH 2014

# A simple error checking tool
check_for_errors(){
    echo "$1" | tail 
    if [ -n "$1" ]
    then
        echo "There seems to be errors, exiting"
        exit
    else
        echo "All OK"
    fi
}

# Checks if a given file exists.
# if it does not, then it downloads it
# from the web. Must be given the filename
# as first argument and the url as the second
# argument.
check_or_download() {
    if [ ! -f $1 ]
    then
        echo "$1 does not exist, downloading."
        wget "$2" --no-check-certificate
    else
        echo -n "$1 exists, will not re-download. Consider "
        echo "removing it if you want a clean install"
    fi
}

set -e

sudo apt-get -y install cvs

mkdir -p msp430-build

#### binutils ###
#################

git clone git://sourceware.org/git/binutils-gdb.git

mkdir -p msp430-binutils

# Configure Binutils
cd msp430-binutils

# We need to build binutils for the msp430
../binutils-gdb/configure --target=msp430-elf

# build binutils
make

# Do the install as root (e.g., sudo)
sudo make install

cd ..

### GCC ###
###########
mkdir -p gcc-trunk
cd gcc-trunk
#  Check out GCC from SVN
svn checkout svn://gcc.gnu.org/svn/gcc/trunk .
# Get GCC prerequisites
./contrib/download_prerequisites
cd ..

mkdir -p msp430-gcc
cd msp430-gcc
# The exact path here might be different
../gcc-trunk/configure --target=msp430-elf --enable-languages=c,c++ --with-newlib=yes
#  Note, you must make all-gcc and install-gcc anything else seems to break.
make all-host
# Do the install as root (e.g., sudo)
sudo make install-host
cd ..

mkdir -p newlib
cd newlib
echo "Enter 'anoncvs' as password"
cvs -z 9 -d :pserver:anoncvs@sourceware.org:/cvs/src login
cvs -z 9 -d :pserver:anoncvs@sourceware.org:/cvs/src co newlib
cd ..

mkdir -p msp430-newlib
# Now Build Newlib for MSP430 (Since this isn't going to run linux or similar OS, we don't need syscalls)
cd msp430-newlib
../newlib/src/configure --target=msp430-elf
make
sudo make install
cd ..

mkdir -p msp430-gdb
cd msp430-gdb
../binutils-gdb/gdb/configure --target=msp430-elf
make
sudo make install
cd ..

# mspdebug
MSPDEBUG_PREFIX='mspdebug-0.22'
mkdir -p mspdebug
cd mspdebug
# get mspdebug
check_or_download "$MSPDEBUG_PREFIX.tar.gz" http://sourceforge.net/projects/mspdebug/files/$MSPDEBUG_PREFIX.tar.gz
tar -xvf $MSPDEBUG_PREFIX
cd $MSPDEBUG_PREFIX
make
sudo make install
cd ../..
